{% extends "scraper/base.html" %}

{% block title %}Website Content Scraper{% endblock %}

{% block content %}
<div class="container" style="max-width: 600px; margin: 50px auto; background: white; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; text-align: center;">
    <h1 style="color: #333;">Choose an Option</h1>
    <div style="margin-top: 30px; display: flex; justify-content: center; gap: 20px;">
        <a href="{% url 'scraper:web_scraping' %}" class="btn" style="background-color: #007bff; color: white; padding: 15px 30px; text-decoration: none; border-radius: 5px; font-size: 16px; transition: background-color 0.3s ease;" onmouseover="this.style.backgroundColor='#0056b3'" onmouseout="this.style.backgroundColor='#007bff'">Web Scraping</a>
        <a href="{% url 'scraper:site_mapping' %}" class="btn" style="background-color: #28a745; color: white; padding: 15px 30px; text-decoration: none; border-radius: 5px; font-size: 16px; transition: background-color 0.3s ease;" onmouseover="this.style.backgroundColor='#218838'" onmouseout="this.style.backgroundColor='#28a745'">Sitemap</a>
    </div>
</div>

<script>
document.getElementById('scrapeForm').addEventListener('submit', function(event) {
    event.preventDefault();

    const form = this;
    const formData = new FormData(form);

    // Hide form and show progress container
    form.style.display = 'none';
    const progressContainer = document.getElementById('progressContainer');
    progressContainer.style.display = 'block';

    // Start scraping by sending POST request via fetch
    fetch("", {
        method: "POST",
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
        },
        body: formData
    }).then(response => response.json())
    .then(data => {
        if (data.status === 'started') {
            // Start polling progress
            pollProgress();
        } else {
            alert('Failed to start scraping.');
            form.style.display = 'flex';
            progressContainer.style.display = 'none';
        }
    }).catch(error => {
        alert('Error starting scraping.');
        form.style.display = 'flex';
        progressContainer.style.display = 'none';
    });
});

function pollProgress() {
    fetch("{% url 'scraper:scrape_progress' %}")
    .then(response => response.json())
    .then(data => {
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const currentPage = document.getElementById('currentPage');
        const totalPages = document.getElementById('totalPages');
        const currentUrl = document.getElementById('currentUrl');
        const statusText = document.getElementById('statusText');

        if (data.status === 'running') {
            const total = data.total_urls || 1;
            const current = data.current_index || 0;
            const percent = Math.min(100, Math.floor((current / total) * 100));
            
            // Update progress bar
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';

            // Update current URL
            const currentUrlText = data.current_url || 'Loading...';
            const displayUrl = currentUrlText.length > 80 ? currentUrlText.substring(0, 80) + '...' : currentUrlText;
            
            // Update all progress elements
            progressText.textContent = `Processing page ${current} of ${total}`;
            currentPage.textContent = current;
            totalPages.textContent = total;
            currentUrl.textContent = displayUrl;
            statusText.textContent = 'Crawling pages...';

            setTimeout(pollProgress, 500);
        } else if (data.status === 'completed') {
            progressBar.style.width = '100%';
            progressBar.textContent = '100%';
            progressText.textContent = 'Scraping completed. Redirecting...';
            statusText.textContent = 'Completed successfully!';
            setTimeout(() => {
                window.location.href = "{% url 'scraper:view_data' %}";
            }, 1500);
        } else if (data.status === 'started') {
            progressText.textContent = 'Initializing scraper...';
            statusText.textContent = 'Starting up...';
            setTimeout(pollProgress, 500);
        } else {
            progressText.textContent = 'Idle.';
            statusText.textContent = 'Waiting for input...';
        }
    }).catch(error => {
        console.error('Error fetching progress:', error);
        document.getElementById('statusText').textContent = 'Connection error, retrying...';
        setTimeout(pollProgress, 2000);
    });
}
</script>
{% endblock %}
